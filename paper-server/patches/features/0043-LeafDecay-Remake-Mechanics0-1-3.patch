From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: LanzoZ <bhbxgre@gmail.com>
Date: Fri, 6 Feb 2026 11:28:48 +0700
Subject: [PATCH] LeafDecay Remake Mechanics0-1-3


diff --git a/net/minecraft/world/level/block/LeavesBlock.java b/net/minecraft/world/level/block/LeavesBlock.java
index d5cc363a503c909aad2e04db256144f611c7f05c..75ae5b63b3f28f6403c31e1410abc0a365fa2e43 100644
--- a/net/minecraft/world/level/block/LeavesBlock.java
+++ b/net/minecraft/world/level/block/LeavesBlock.java
@@ -65,31 +65,41 @@ public abstract class LeavesBlock extends Block implements SimpleWaterloggedBloc
 
     @Override
     protected void randomTick(BlockState state, ServerLevel level, BlockPos pos, RandomSource random) {
-        // ถ้าผู้เล่นตั้งใจวาง (Persistent) ก็ไม่ต้องให้มันเหี่ยว
-        if (state.getValue(PERSISTENT)) return;
+        // 1. ถ้าเป็นใบไม้ที่ผู้เล่นวาง (Persistent) ไม่ต้องให้มันเหี่ยว
+        if (state.getValue(PERSISTENT)) {
+            return;
+        }
 
-        // แทนที่จะเช็ค Distance เราจะเช็คว่า "มีไม้ในระยะที่กำหนดไหม"
-        // โดยใช้ฟังก์ชันที่เราต้องเขียนขึ้นเอง (เช่น เช็คในรัศมี 4-6 บล็อก)
+        // 2. แทนที่จะเช็คค่า DISTANCE == 7 (แบบปกติ)
+        // เราจะใช้การ "กวาดสายตา" หา Note Block หรือ Log รอบๆ แทน
         if (!hasLogNearby(level, pos)) {
 
-            // เรียก Event ปกติ
-            org.bukkit.event.block.LeavesDecayEvent event = new org.bukkit.event.block.LeavesDecayEvent(org.bukkit.craftbukkit.block.CraftBlock.at(level, pos));
+            // 3. เรียก Event ของ Bukkit เพื่อให้ปลักอินอื่น (ถ้ามี) ตรวจสอบ
+            org.bukkit.event.block.LeavesDecayEvent event = new org.bukkit.event.block.LeavesDecayEvent(
+                org.bukkit.craftbukkit.block.CraftBlock.at(level, pos)
+            );
             level.getCraftServer().getPluginManager().callEvent(event);
 
-            if (!event.isCancelled()) {
-                dropResources(state, level, pos);
-                level.removeBlock(pos, false);
+            if (event.isCancelled()) {
+                return;
             }
+
+            // 4. สั่งทำลายตัวเอง (เหี่ยว)
+            dropResources(state, level, pos);
+            level.removeBlock(pos, false);
         }
     }
 
-    // ฟังก์ชันสำหรับสแกนหาบล็อกไม้ (Note Block หรือ Logs) รอบๆ
+    // ฟังก์ชันช่วยเช็คว่ามี "แกนกลาง" อยู่ใกล้ๆ ไหม
     private boolean hasLogNearby(ServerLevel level, BlockPos pos) {
-        // สแกนหาบล็อกในระยะ (รัศมี 4 บล็อก ตามมาตรฐาน Vanilla)
-        for (BlockPos checkPos : BlockPos.betweenClosed(pos.offset(-4, -4, -4), pos.offset(4, 4, 4))) {
+        int radius = 4; // รัศมีที่ใบไม้จะมองหาลำต้น (ปกติ Vanilla คือ 4-6)
+
+        // วนลูปเช็คบล็อกรอบๆ ในระยะ radius
+        for (BlockPos checkPos : BlockPos.betweenClosed(pos.offset(-radius, -radius, -radius), pos.offset(radius, radius, radius))) {
             BlockState neighbor = level.getBlockState(checkPos);
-            // เช็คว่าเป็น Log หรือ Note Block (ลำต้น Custom ของคุณ)
-            if (neighbor.is(BlockTags.LOGS) || neighbor.is(net.minecraft.world.level.block.Blocks.NOTE_BLOCK)) {
+
+            // ถ้าเจอ Note Block (แกน custom) หรือ Logs ปกติ ให้ถือว่ายังมีชีวิตอยู่ได้
+            if (neighbor.is(net.minecraft.world.level.block.Blocks.NOTE_BLOCK) || neighbor.is(org.bukkit.Tag.LOGS.getKey().toString().contains("logs") ? BlockTags.LOGS : BlockTags.LOGS)) {
                 return true;
             }
         }
